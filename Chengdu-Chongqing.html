<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chengdu & Chongqing Trip 2024</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'snow-white': '#F9FAFB', 'ice-blue': '#E0F2FE', 'light-snow-blue': '#F0F9FF',
                        'deep-sea-blue': '#0369A1', 'accent-yellow': '#FBBF24', 'spicy-red': '#DC2626', 'soft-gray': '#F3F4F6',
                        'icon-orange': '#F97316', 'icon-blue': '#2563EB', 'icon-green': '#10B981',
                        'icon-red': '#EF4444', 'icon-purple': '#8B5CF6', 'icon-grey': '#64748B'
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { background-color: #F0F9FF; -webkit-tap-highlight-color: transparent; font-family: 'Noto Sans TC', sans-serif; color: #334155; }
        .app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; background-color: #ffffff; box-shadow: 0 0 30px rgba(0, 0, 0, 0.05); position: relative; padding-bottom: 90px; }
        .header-bg { background-color: #ffffff; position: relative; overflow: hidden; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15); border-bottom-left-radius: 35px; border-bottom-right-radius: 35px; z-index: 10; }
        .header-image-container { width: 100%; height: 250px; overflow: hidden; background-color: #fdf2f8; border-bottom-left-radius: 35px; border-bottom-right-radius: 35px; position: relative; }
        
        /* 圖片樣式 */
        .header-image-container img { width: 100%; height: 100%; object-fit: cover; display: block; opacity: 1; } 
        
        .snow-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; pointer-events: none; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><circle cx="50" cy="50" r="1" fill="white" opacity="0.3"/></svg>'); }
        
        .side-tab-bar { position: absolute; bottom: 45px; right: 16px; z-index: 30; display: flex; flex-direction: row; gap: 8px; }
        .tab-button { width: 40px; height: 40px; border-radius: 9999px; display: flex; align-items: center; justify-content: center; font-size: 1.125rem; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); transition: all 0.2s ease; background: white; color: #7DD3FC; }
        .tab-button.active { background-color: #0369A1; color: #ffffff; box-shadow: 0 6px 15px rgba(3, 105, 161, 0.4); transform: scale(1.05); }
        
        .app-main { padding-top: 25px !important; position: relative; z-index: 5; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .card-shadow { box-shadow: 0 4px 20px rgba(186, 230, 253, 0.3); transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .note-content { max-height: 2.5rem; overflow: hidden; transition: max-height 0.3s ease-out; line-height: 1.6; font-size: 0.9rem; }
        .note-content b { font-weight: 800; } 
        .note-content.expanded { max-height: 1000px; }
        
        .expenses-banner { background: linear-gradient(135deg, #BE123C 0%, #FB7185 100%); }
        .date-selector-sticky { background-color: #ffffff; border-bottom: 1px solid #f0f0f0; z-index: 20; top: 0; }
        
        /* 編輯器樣式 */
        .rich-editor-toolbar { padding: 8px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; flex-direction: column; gap: 5px; }
        .rich-editor-content { min-height: 200px; max-height: 400px; overflow-y: auto; padding: 12px; outline: none; background: white; font-size: 14px; line-height: 1.6; }
        .tool-btn { padding: 4px 8px; border-radius: 4px; background: white; border: 1px solid #e2e8f0; margin-right: 3px; font-size: 12px; cursor: pointer; }
        .color-dot { width: 20px; height: 20px; border-radius: 50%; display: inline-block; cursor: pointer; border: 1px solid #ddd; }
        
        /* 狀態診斷面板 */
        .debug-panel { position: absolute; top: 10px; left: 10px; z-index: 50; background: rgba(0,0,0,0.6); padding: 6px 10px; border-radius: 20px; color: white; font-size: 11px; backdrop-filter: blur(4px); display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .bg-green-500 { background-color: #22c55e; box-shadow: 0 0 5px #22c55e; }
        .bg-red-500 { background-color: #ef4444; }
        .bg-yellow-500 { background-color: #eab308; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .loading-screen { position: fixed; inset: 0; background: white; z-index: 100; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #0369A1; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .expense-category-tag { min-width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; flex-shrink: 0; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body>

<div id="app" class="app-container">

    <div v-if="isLoading" class="loading-screen">
        <div class="spinner mb-4"></div>
        <p class="font-bold text-slate-600">正在同步雲端行程...</p>
    </div>

    <div class="header-bg relative">
        <div class="header-image-container">
            <img src="https://i.imgur.com/8xPABCQ.jpeg" alt="成都重慶之旅">
        </div>
        
        <div class="debug-panel">
            <div class="status-dot" :class="statusColor"></div>
            <span class="font-bold">{{ syncStatusText }}</span>
        </div>

        <div class="snow-layer"></div>
        <div class="side-tab-bar">
            <button @click="currentTab='itinerary'" :class="{'active': currentTab==='itinerary'}" class="tab-button"><i class="fa-solid fa-map-location-dot"></i></button>
            <button @click="currentTab='info'" :class="{'active': currentTab==='info'}" class="tab-button"><i class="fa-solid fa-circle-info"></i></button>
            <button @click="currentTab='shopping'" :class="{'active': currentTab==='shopping'}" class="tab-button"><i class="fa-solid fa-basket-shopping"></i></button>
            <button @click="currentTab='expenses'" :class="{'active': currentTab==='expenses'}" class="tab-button"><i class="fa-solid fa-coins"></i></button>
        </div>
    </div>

    <main class="p-4 app-main">
        <div v-if="currentTab === 'itinerary'" class="animate-fade-in">
            <div class="flex overflow-x-auto hide-scrollbar space-x-3 pb-4 mb-2 px-1 sticky top-0 bg-white z-20 pt-2 -mx-4 px-4 border-b border-gray-100">
                <div v-for="(day, index) in dates" :key="index" @click="selectedDateIndex = index"
                     class="flex-shrink-0 w-[58px] h-[68px] rounded-xl flex flex-col items-center justify-center cursor-pointer transition-all border-2 shadow-sm"
                     :class="selectedDateIndex === index ? 'bg-deep-sea-blue text-white border-deep-sea-blue scale-105' : 'bg-white text-gray-400 border-white'">
                    <span class="text-sm font-bold">{{ day.weekday }}</span> 
                    <span class="text-xs opacity-70">{{ day.date }}</span> 
                </div>
            </div>

            <div v-if="weatherData[selectedDateIndex]" class="mb-4 bg-snow-white border border-ice-blue rounded-2xl p-4 flex justify-between items-center shadow-md">
                <div class="flex items-start text-deep-sea-blue space-x-4">
                    <i :class="getWeatherIcon(weatherData[selectedDateIndex].condition)" class="text-4xl text-blue-500"></i>
                    <div class="pt-1">
                        <span class="text-2xl font-extrabold">{{ weatherData[selectedDateIndex].temp.split('/')[0] }}°</span>
                        <span class="text-sm font-light text-slate-500 ml-1">/ {{ weatherData[selectedDateIndex].temp.split('/')[1] }}°C</span>
                        <span class="block text-xs text-slate-600 mt-1">體感: {{ weatherData[selectedDateIndex].feel }}°C</span>
                    </div>
                </div>
                <div class="text-right text-xs text-gray-600 pl-3">
                    <span class="font-bold block text-slate-700">{{ getWeatherDescription(weatherData[selectedDateIndex].condition) }}</span>
                    <span v-if="dates[selectedDateIndex].hasTrain" class="mt-1 block text-deep-sea-blue font-bold"><i class="fa-solid fa-train text-accent-yellow"></i> 高鐵移動日</span>
                    <span v-else class="mt-1 block text-slate-400">本日市區遊覽</span>
                </div>
            </div>

            <div class="space-y-4 pb-20">
                <div v-for="(item, idx) in currentItinerary" :key="item.id" class="relative">
                    <div v-if="idx > 0" class="pl-8 pb-2 flex items-center text-xs text-gray-400">
                        <div class="h-6 w-0.5 bg-gray-200 absolute left-6 -top-3"></div>
                        <i :class="getTransportIcon(currentItinerary[idx].transportType)" class="mr-2" @click="openMapDirections(currentItinerary[idx-1], item)"></i>
                        <span class="font-bold">{{ item.travelTime || '移動' }}</span>
                    </div>
                    
                    <div class="bg-white rounded-3xl p-5 card-shadow flex items-start border border-ice-blue/50 relative">
                        <div class="mr-4 flex flex-col items-center min-w-[50px]">
                            <div class="w-10 h-10 rounded-full text-white shadow-md flex items-center justify-center text-lg mb-1" :class="getCategoryColor(item.category)">
                                <i :class="getCategoryIcon(item.category)"></i>
                            </div>
                            <span v-if="item.startTime" class="text-xs font-bold text-slate-600 mt-1">{{ item.startTime }}</span>
                        </div>
                        <div class="flex-1 pb-1 pr-6">
                            <h3 class="text-lg font-bold text-gray-800 leading-tight">{{ item.name }}</h3>
                            <div class="text-sm text-gray-500 mt-2 space-y-1">
                                <p v-if="item.hours" class="flex items-center"><i class="fa-regular fa-clock w-4 text-center mr-2 text-ice-blue"></i> 營業: {{ item.hours }}</p>
                                <p v-if="item.price" class="flex items-center"><i class="fa-solid fa-ticket w-4 text-center mr-2 text-ice-blue"></i> 費用: {{ item.price }}</p>
                                <p v-if="item.address" @click="openMap(item.address)" class="cursor-pointer hover:text-blue-500"><i class="fa-solid fa-location-dot w-4 text-center mr-1 text-ice-blue"></i> {{ item.address }}</p>
                            </div>
                            <div v-if="item.note && item.note.length > 0" class="mt-3 text-xs bg-gray-50 p-2.5 rounded-lg border border-gray-100">
                                <p class="text-slate-600 font-bold mb-1 flex items-center"><i class="fa-solid fa-highlighter text-accent-yellow mr-2"></i> 備註</p>
                                <div class="note-content text-slate-600" :class="{'expanded': item.isNoteExpanded}" v-html="formatNoteDisplay(item.note)"></div>
                                <button v-if="item.note.length > 50 || item.note.includes('<')" @click="item.isNoteExpanded = !item.isNoteExpanded" class="text-deep-sea-blue font-bold mt-1 block">{{ item.isNoteExpanded ? '收合備註' : '查看更多...' }}</button>
                            </div>
                        </div>
                        <div class="absolute top-3 right-3 flex flex-col space-y-1">
                            <button @click.stop="moveItem(idx, -1)" v-if="idx>0" class="w-7 h-7 bg-gray-100 rounded-full text-xs text-gray-500"><i class="fa-solid fa-arrow-up"></i></button>
                            <button @click.stop="moveItem(idx, 1)" v-if="idx<currentItinerary.length-1" class="w-7 h-7 bg-gray-100 rounded-full text-xs text-gray-500"><i class="fa-solid fa-arrow-down"></i></button>
                            <button @click.stop="editItem(item)" class="w-7 h-7 bg-blue-50 text-blue-600 rounded-full text-xs"><i class="fa-solid fa-pencil"></i></button>
                        </div>
                    </div>
                </div>
                <div v-if="currentItinerary.length === 0" class="text-center py-10 text-gray-300">
                    <p>本日無行程，點擊右下角新增</p>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'info'" class="space-y-5 animate-fade-in">
            <div class="bg-gradient-to-r from-red-600 to-pink-500 rounded-3xl p-6 text-white shadow-xl relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-10 -mt-10 blur-2xl"></div>
                <div class="absolute bottom-0 left-0 w-32 h-32 
bg-white/10 rounded-full -ml-10 -mb-10 blur-2xl"></div>
                <h3 class="font-bold text-lg mb-4 flex items-center relative z-10"><i class="fa-solid fa-calculator mr-2"></i> 匯率換算</h3>
                <div class="flex items-center justify-between space-x-3 relative z-10">
                    <div class="flex-1">
                        <label class="text-[10px] 
text-red-200 block mb-1 uppercase tracking-wider">CNY (人民幣)</label>
                        <input type="number" v-model="currencyInput" @input="calcRate" class="w-full bg-white/20 border border-white/30 rounded-xl px-3 py-2.5 text-white placeholder-white/50 focus:outline-none focus:bg-white/30 text-lg font-bold" placeholder="¥">
                    </div>
                    <i class="fa-solid fa-arrow-right-arrow-left text-red-200 mt-5"></i>
                    <div class="flex-1">
                        <label class="text-[10px] text-red-200 block mb-1 uppercase tracking-wider">HKD (港幣)</label>
                        <div class="w-full bg-white/10 rounded-xl px-3 py-2.5 text-white text-lg font-bold border border-transparent">
                            $ {{ currencyResult }}
                        </div>
                    </div>
                </div>
                <p class="text-[10px] text-red-200 mt-3 text-right relative z-10">預設匯率: {{ exchangeRate }}</p>
            </div>
            
            <div class="bg-slate-100 rounded-3xl p-5 border border-slate-200 text-center">
                <h3 class="font-bold text-slate-600 mb-2">資料庫管理</h3>
                <p class="text-xs text-slate-400 mb-3">如果行程表一片空白，請按此按鈕初始化。</p>
                <button @click="resetToDefault" class="bg-red-500 text-white px-4 py-2 rounded-xl text-sm font-bold shadow-md active:scale-95 transition-transform"><i class="fa-solid fa-rotate-left mr-2"></i> 強制寫入預設行程 (9天)</button>
            </div>

            <div class="bg-white rounded-3xl p-6 card-shadow">
                <h3 class="font-bold text-slate-800 mb-4 border-b border-slate-100 pb-3"><i class="fa-solid fa-hotel text-indigo-500 mr-2"></i> 住宿資訊</h3>
                <ul class="space-y-5">
                    <li v-for="hotel in hotels" class="border-b last:border-0 pb-4 last:pb-0">
                        <div class="flex justify-between items-start group">
                            <div class="flex-1">
                                <span class="font-bold block text-slate-700 text-lg">{{ hotel.name }}</span>
                                <span class="text-xs text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full inline-block mt-1">{{ hotel.date }}</span>
                            </div>
                            <button @click="openMap(hotel.name)" class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-500 flex items-center justify-center group-hover:bg-indigo-500 group-hover:text-white transition-all"><i class="fa-solid fa-location-arrow text-xs"></i></button>
                        </div>
                        <div class="text-sm text-slate-500 mt-2 space-y-1">
                            <p class="flex items-start"><i class="fa-solid fa-map-pin w-4 text-center mr-2 mt-1 text-slate-300"></i> {{ hotel.address }}</p>
                        </div>
                    </li>
                </ul>
            </div>
            
            <div class="bg-red-50 rounded-3xl p-6 border border-red-100">
                <h3 class="font-bold text-red-800 mb-4"><i class="fa-solid fa-kit-medical mr-2"></i> 緊急聯絡</h3>
                <div class="grid grid-cols-2 gap-4 text-center">
                    <a href="tel:110" class="bg-white py-3 rounded-xl shadow-sm text-red-600 font-bold block border border-red-100 hover:bg-red-600 hover:text-white transition-all">
                        <i class="fa-solid fa-user-shield mr-1"></i> 公安 110
                    </a>
                    <a href="tel:120" class="bg-white py-3 rounded-xl shadow-sm text-red-600 font-bold block border border-red-100 hover:bg-red-600 
hover:text-white transition-all">
                        <i class="fa-solid fa-truck-medical mr-1"></i> 急救 120
                    </a>
                </div>
                <div class="mt-4 text-xs text-red-500 text-center">
                    <p>高山症預警：九寨溝/黃龍海拔較高，請注意身體狀況。</p>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'shopping'" class="animate-fade-in">
            <div class="grid grid-cols-2 gap-4">
                <div v-for="(item, idx) in shoppingList" :key="idx" class="bg-white rounded-2xl p-3 card-shadow relative group">
                    <div class="aspect-square bg-slate-50 rounded-xl mb-3 overflow-hidden relative border border-slate-100">
                        <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                        <div v-else class="w-full h-full flex items-center justify-center text-slate-300">
                            <i class="fa-solid fa-bag-shopping text-3xl"></i>
                        </div>
                        <button @click="deleteShoppingItem(idx)" class="absolute top-2 right-2 bg-black/60 text-white rounded-full w-7 h-7 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <p class="font-bold text-sm text-slate-800 truncate px-1">{{ item.name }}</p>
                </div>
                
                <div v-if="shoppingList.length % 2 !== 0" class="h-0 invisible"></div>
                
                <div v-if="shoppingList.length === 0" class="col-span-2 text-center py-16 text-slate-300">
                    <i class="fa-solid fa-bag-shopping text-5xl mb-3 text-slate-200"></i>
                    <p class="text-sm">購物清單空白<br>重慶火鍋底料、熊貓週邊...</p>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'expenses'" class="animate-fade-in">
            <div class="expenses-banner text-white rounded-3xl p-8 mb-6 relative overflow-hidden">
               
                <div class="absolute -right-10 -top-10 bg-white/10 w-48 h-48 rounded-full blur-3xl"></div>
                <div class="absolute -left-10 -bottom-10 bg-orange-400/20 w-40 h-40 rounded-full blur-2xl"></div>
                <p class="text-sm text-red-100 mb-2 relative z-10">目前總花費 (CNY)</p>
                <h2 class="text-5xl font-bold relative z-10 tracking-tight">¥ {{ formatNumber(totalExpensesCNY) }}</h2>
                <p class="text-sm text-right mt-2 opacity-80 
relative z-10">約 HK$ {{ formatNumber(totalExpensesHKD) }}</p>
            </div>

            <div class="bg-white rounded-t-3xl min-h-[500px] p-6 shadow-[0_-10px_40px_rgba(0,0,0,0.03)] -mx-4 px-8">
                <h3 class="font-bold text-slate-800 mb-5 flex items-center">
                    <i class="fa-solid fa-receipt text-slate-300 mr-2"></i>支出紀錄
                </h3>
                <div class="space-y-5">
                    <div v-for="(exp, idx) in expenses" :key="idx" class="flex items-center justify-between border-b border-slate-50 pb-4 last:border-0">
                        <div class="flex items-center">
                            
                            <div class="expense-category-tag mr-4" :class="[getCategoryColor(exp.category), 'text-white']">
                                {{ getCategoryLabel(exp.category) }}
                            </div>
                            <div>
                                <p class="font-bold text-slate-700 text-sm mb-0.5">{{ exp.name }}</p>
                                <p class="text-[10px] text-slate-400 uppercase tracking-wide">{{ exp.date }} · {{ exp.payment === 'card' ?
'電子支付' : '現金' }}</p>
                            </div>
                        </div>
                        <div class="text-right flex items-center">
                            <p class="font-bold text-slate-700">¥{{ formatNumber(exp.amount) }}</p>
                            <button @click="deleteExpenseItem(idx)" class="w-5 h-5 ml-3 text-red-300 hover:text-red-500 transition-colors flex items-center justify-center">
                                <i class="fa-solid fa-xmark text-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

 
    <button v-if="currentTab !== 'info'" @click="handleAddClick" class="fixed bottom-6 right-6 w-14 h-14 bg-accent-yellow rounded-full fab-shadow text-white text-2xl flex items-center justify-center hover:scale-110 transition-transform z-40">
        <i class="fa-solid fa-plus"></i>
    </button>

    <div v-if="showShoppingModal" class="fixed inset-0 bg-deep-sea-blue/40 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-5 text-center text-slate-800">新增購物清單</h3>
            <input v-model="newShoppingItem.name" type="text" placeholder="商品名稱" class="w-full 
bg-slate-50 border-none rounded-xl p-4 mb-4 focus:ring-2 focus:ring-deep-sea-blue text-sm">
            <div class="relative mb-6">
                <input type="file" @change="handleImageUpload" class="hidden" id="fileInput">
                <label for="fileInput" class="w-full h-36 bg-slate-50 border-2 border-dashed border-slate-200 rounded-xl flex items-center justify-center cursor-pointer text-slate-400 hover:bg-slate-100 hover:border-border-slate-300 transition-all">
                    <span v-if="!newShoppingItem.image" class="flex flex-col items-center text-xs">
                        <i class="fa-solid fa-camera text-2xl mb-2"></i> 上傳照片
                    </span>
                    <img v-else :src="newShoppingItem.image" class="h-full w-full object-contain rounded-xl">
                </label>
           
            </div>
            <div class="flex space-x-3">
                <button @click="showShoppingModal = false" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-500 font-bold text-sm">取消</button>
                <button @click="addShoppingItem" class="flex-1 py-3 rounded-xl bg-deep-sea-blue text-white font-bold text-sm shadow-lg shadow-deep-sea-blue/30">新增</button>
            </div>
        </div>
    </div>
    
    <div v-if="showExpenseModal" class="fixed inset-0 bg-deep-sea-blue/40 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-5 text-center text-slate-800">記一筆</h3>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <input v-model="newExpense.date" type="date" class="bg-slate-50 rounded-xl p-3 text-sm text-slate-600 outline-none">
                <select v-model="newExpense.category" class="bg-slate-50 
rounded-xl p-3 text-sm text-slate-600 outline-none">
                    <option value="food">飲食</option>
                    <option value="shopping">購物</option>
                    <option value="transport">交通</option>
                    <option value="stay">住宿</option>
                    <option value="ticket">門票</option>
                    <option value="other">其他</option>
                </select>
            </div>
            <input v-model="newExpense.name" placeholder="名稱 (如: 串串香)" class="w-full bg-slate-50 rounded-xl p-4 mb-4 text-sm outline-none focus:ring-2 focus:ring-accent-yellow">
            <div class="relative mb-4">
   
                <span class="absolute left-4 top-4 text-slate-400 font-bold">¥</span>
                <input v-model.number="newExpense.amount" type="number" placeholder="金額" class="w-full bg-slate-50 rounded-xl p-4 pl-8 text-sm outline-none focus:ring-2 focus:ring-accent-yellow font-bold text-lg">
            </div>
            <div class="flex space-x-3 mb-6">
                <button @click="newExpense.payment='cash'" :class="newExpense.payment==='cash' ? 'bg-deep-sea-blue text-white' : 'bg-slate-100 text-slate-500'" class="flex-1 py-3 rounded-xl text-sm transition-colors"><i class="fa-solid fa-coins mr-1"></i> 現金</button>
                <button @click="newExpense.payment='card'" :class="newExpense.payment==='card' ? 'bg-deep-sea-blue text-white' : 'bg-slate-100 text-slate-500'" class="flex-1 py-3 rounded-xl text-sm transition-colors"><i class="fa-solid fa-mobile-screen mr-1"></i> 電子支付</button>
            </div>
            <div class="flex space-x-3">
                <button @click="showExpenseModal = false" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-500 font-bold text-sm">取消</button>
                <button @click="addExpense" class="flex-1 py-3 rounded-xl bg-accent-yellow text-white font-bold text-sm shadow-lg shadow-accent-yellow/30">儲存</button>
            </div>
        </div>
    </div>
    
    <div v-if="showItineraryModal" class="fixed inset-0 bg-deep-sea-blue/40 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-lg mb-5 text-center text-slate-800">{{ isEditMode ? '編輯行程' : '新增行程' }}</h3>
            <div class="space-y-3">
                <select v-model="newItinerary.category" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none">
                    <option value="sightseeing">景點 (綠)</option>
                    <option value="food">飲食 (紅)</option>
                    <option value="transport">交通 (橙)</option>
                    <option value="shopping">購物 (紫)</option>
                    <option value="accommodation">住宿 (紫)</option>
                    <option value="flight">航班 (藍)</option>
                    <option value="other">其他 (灰)</option>
                </select>
                <input v-model="newItinerary.name" placeholder="名稱" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-deep-sea-blue">
                <input v-model="newItinerary.address" placeholder="地址/地點 (Google Map 搜尋用)" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-deep-sea-blue">
                <div class="grid grid-cols-2 gap-3">
                    <input v-model="newItinerary.startTime" type="text" placeholder="時間 (e.g. 09:30)" class="bg-slate-50 rounded-xl p-3 text-sm outline-none">
                    <select v-model="newItinerary.transportType" class="bg-slate-50 rounded-xl p-3 text-sm outline-none">
                        <option value="walk">步行</option>
                        <option value="car">打車/包車</option>
                        <option value="bus">巴士</option>
                        <option value="public">地鐵/高鐵</option>
                        <option value="flight">飛機</option>
                        <option value="boat">乘船</option>
                        <option value="other">其他</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <input v-model="newItinerary.travelTime" type="text" placeholder="車程/移動時間" class="bg-slate-50 rounded-xl p-3 text-sm outline-none">
                    <input v-model="newItinerary.hours" type="text" placeholder="營業時間" class="bg-slate-50 rounded-xl p-3 text-sm outline-none">
                </div>
                <input v-model="newItinerary.price" type="text" placeholder="門票/費用" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-deep-sea-blue">
                
                <div class="w-full bg-slate-50 rounded-xl border border-slate-200 overflow-hidden">
                    <div class="rich-editor-toolbar flex flex-col gap-2">
                        <div class="flex flex-wrap items-center">
                            <button @mousedown.prevent="execCmd('bold')" class="tool-btn" title="粗體"><i class="fa-solid fa-bold"></i></button>
                            <div class="w-px h-5 bg-slate-300 mx-1"></div>
                            <button @mousedown.prevent="execCmd('fontSize', '1')" class="tool-btn" title="小字"><i class="fa-solid fa-font text-[10px]"></i></button>
                            <button @mousedown.prevent="execCmd('fontSize', '3')" class="tool-btn" title="正常"><i class="fa-solid fa-font text-xs"></i></button>
                            <button @mousedown.prevent="execCmd('fontSize', '5')" class="tool-btn" title="大字"><i class="fa-solid fa-font text-lg"></i></button>
                            <div class="w-px h-5 bg-slate-300 mx-1"></div>
                            <button @mousedown.prevent="execCmd('removeFormat')" class="tool-btn" title="清除格式"><i class="fa-solid fa-eraser"></i></button>
                        </div>
                        
                        <div class="flex items-center gap-1.5 overflow-x-auto hide-scrollbar">
                            <span class="text-[10px] text-slate-400 flex-shrink-0">字:</span>
                            <span @mousedown.prevent="execCmd('foreColor', '#000000')" class="color-dot bg-black" title="黑色"></span>
                            <span @mousedown.prevent="execCmd('foreColor', '#DC2626')" class="color-dot bg-red-600" title="紅色"></span>
                            <span @mousedown.prevent="execCmd('foreColor', '#2563EB')" class="color-dot bg-blue-600" title="藍色"></span>
                            <span @mousedown.prevent="execCmd('foreColor', '#059669')" class="color-dot bg-emerald-600" title="綠色"></span>
                            <span @mousedown.prevent="execCmd('foreColor', '#9333EA')" class="color-dot bg-purple-600" title="紫色"></span>
                            <span @mousedown.prevent="execCmd('foreColor', '#EA580C')" class="color-dot bg-orange-600" title="橘色"></span>
                            <span @mousedown.prevent="execCmd('foreColor', '#57534E')" class="color-dot bg-stone-600" title="灰色"></span>
                        </div>

                        <div class="flex items-center gap-1.5 overflow-x-auto hide-scrollbar">
                            <span class="text-[10px] text-slate-400 flex-shrink-0">底:</span>
                            <span @mousedown.prevent="execCmd('hiliteColor', '#FEF08A')" class="color-dot bg-yellow-200" title="黃底"></span>
                            <span @mousedown.prevent="execCmd('hiliteColor', '#BAE6FD')" class="color-dot bg-sky-200" title="藍底"></span>
                            <span @mousedown.prevent="execCmd('hiliteColor', '#BBF7D0')" class="color-dot bg-green-200" title="綠底"></span>
                            <span @mousedown.prevent="execCmd('hiliteColor', '#FBCFE8')" class="color-dot bg-pink-200" title="粉底"></span>
                            <span @mousedown.prevent="execCmd('hiliteColor', '#E9D5FF')" class="color-dot bg-purple-200" title="紫底"></span>
                            <span @mousedown.prevent="execCmd('hiliteColor', 'transparent')" class="color-dot border-dashed border-slate-400 bg-transparent flex items-center justify-center" title="無底色"><i class="fa-solid fa-slash text-[8px] text-slate-400"></i></span>
                        </div>
                    </div>
                    <div 
                        id="noteEditor"
                        contenteditable="true" 
                        class="rich-editor-content text-sm"
                        @input="updateNoteContent"
                    ></div>
                </div>

            </div>
            <div class="flex space-x-3 mt-6">
                <button @click="showItineraryModal = false; isEditMode = false" :class="isEditMode ? 'w-1/3' : 'flex-1'" class="py-3 rounded-xl bg-slate-100 text-slate-500 font-bold text-sm">取消</button>
                
                <button v-if="isEditMode" @click="deleteItem" class="w-1/3 py-3 rounded-xl bg-red-100 text-red-600 font-bold text-sm hover:bg-red-200 transition-colors">
                    <i class="fa-solid fa-trash-can mr-1"></i> 刪除
                </button>
                
                <button @click="saveItineraryItem" :class="isEditMode ? 'w-1/3' : 'flex-1'" class="py-3 rounded-xl bg-deep-sea-blue text-white font-bold text-sm shadow-lg shadow-deep-sea-blue/30">{{ isEditMode ? '儲存修改' : '新增行程' }}</button>
            </div>
        </div>
    </div>


</div> <script>
    const { createApp, ref, computed, onMounted, nextTick, watch } = Vue

    // ★★★ 您的 Firebase Config (已填入) ★★★
    const firebaseConfig = {
        apiKey: "AIzaSyCWj5ms9W1VCLPijZ6wnEZ9vdgmKoiImb8",
        authDomain: "chengdu-chongqing.firebaseapp.com",
        projectId: "chengdu-chongqing",
        storageBucket: "chengdu-chongqing.firebasestorage.app",
        messagingSenderId: "747116521040",
        appId: "1:747116521040:web:64200506a226359f3b5355",
        measurementId: "G-KTMJERHN72"
    };

    // 初始化 Firebase (Compat版)
    let db = null;
    let docRef = null;
    // 使用新的文件ID以避免舊格式衝突
    const TRIP_DOC_ID = "trip-data-v3-final"; 

    try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.firestore();
        docRef = db.collection("trips").doc(TRIP_DOC_ID);
        console.log("Firebase initialized");
    } catch (e) {
        console.error("Firebase init failed", e);
    }

    createApp({
        setup() {
            // --- 預設完整 9 天資料 ---
            const initialItinerary = [
                // Day 1: 12/24 (三)
                [
                    { id: 101, category: 'transport', startTime: '07:15', name: '香港出發 (油塘)', note: '環島中港通 (記得買票)', transportType: 'bus' },
                    { id: 102, category: 'transport', startTime: '11:00', name: '深圳寶安機場 抵達', note: '準備辦理登機', transportType: 'bus', travelTime: '3h45m' },
                    { id: 103, category: 'flight', startTime: '13:45', name: '飛往成都 (CA4340)', note: '中國國航 CA4340\n預計 16:30 抵達成都雙流T2', transportType: 'flight', travelTime: '2h45m' },
                    { id: 104, category: 'transport', startTime: '16:30', name: '機場 -> 市區', note: '滴滴打車進市區', transportType: 'car', travelTime: '30m' },
                    { id: 105, category: 'accommodation', startTime: '17:00', name: '入住: 龍之夢瑞峯公寓', note: '寄放行李、辦理入住', transportType: 'walk' },
                    { id: 106, category: 'sightseeing', startTime: '19:00', name: '望平街', note: '逛街、晚餐', hours: '19:00-22:00', transportType: 'walk' },
                    { id: 107, category: 'accommodation', startTime: '23:00', name: '返回酒店休息', note: '', transportType: 'walk' }
                ],
                // Day 2: 12/25 (四)
                [
                    { id: 200, category: 'food', startTime: '07:30', name: '早餐', note: '', transportType: 'walk' },
                    { id: 201, category: 'transport', startTime: '08:49', name: '成都東 -> 樂山站', note: '高鐵 D1791 (08:49 - 09:35)', transportType: 'public', travelTime: '46m' },
                    { id: 202, category: 'transport', startTime: '09:35', name: '樂山站 -> 烏尤壩碼頭', note: '因水位原因暫停了嘉州渡碼頭，需到烏尤壩碼頭登船', transportType: 'car', travelTime: '35m' },
                    { id: 203, category: 'sightseeing', startTime: '10:15', name: '船遊樂山大佛', note: '觀賞大佛全景 (可步道或遊船)', price: '船票', transportType: 'boat' },
                    { id: 204, category: 'food', startTime: '12:30', name: '午餐: 蹺腳牛肉', note: '樂山必吃', hours: '12:30-13:30', transportType: 'car' },
                    { id: 205, category: 'transport', startTime: '14:30', name: '樂山站 -> 成都東', note: '滴滴到樂山站，高鐵返回', transportType: 'public', travelTime: '1h' },
                    { id: 206, category: 'sightseeing', startTime: '17:00', name: '寬窄巷子/錦里古街', note: '夜逛', transportType: 'car', travelTime: '40m' }
                ],
                // Day 3: 12/26 (五)
                [
                    { id: 300, category: 'food', startTime: '06:30', name: '早餐', note: '早起出發', transportType: 'walk' },
                    { id: 301, category: 'transport', startTime: '08:04', name: '成都東 -> 峨眉山站', note: '高鐵 C6343 (08:04 - 09:11)', transportType: 'public', travelTime: '67m' },
                    { id: 302, category: 'transport', startTime: '09:11', name: '前往雷洞坪', note: '站內沿"景區"提示走，乘景區車 (車程2小時)', transportType: 'bus', travelTime: '2h' },
                    { id: 303, category: 'walk', startTime: '11:30', name: '步行至索道入口', note: '接引殿 (約25分鐘)', transportType: 'walk', travelTime: '25m' },
                    { id: 304, category: 'sightseeing', startTime: '12:00', name: '峨眉山金頂', note: '坐纜車上山 (5分鐘) + 步行15分鐘。\n世界最高十方普賢菩薩聖像，金光閃閃。', price: '門票+索道', transportType: 'other' },
                    { id: 305, category: 'transport', startTime: '15:00', name: '下山折返', note: '落山需2.5-3小時。\n尾班車17:00', transportType: 'bus', travelTime: '3h' },
                    { id: 306, category: 'transport', startTime: '18:00', name: '峨眉山站 -> 成都', note: 'C6344 (18:01) 或 C6264 (18:30)', transportType: 'public', travelTime: '77m' },
                    { id: 307, category: 'food', startTime: '19:30', name: '春熙路晚餐', note: '', transportType: 'public' }
                ],
                // Day 4: 12/27 (六)
                [
                    { id: 401, category: 'food', startTime: '08:00', name: '早餐 & 退房', note: '食飽D', transportType: 'walk' },
                    { id: 402, category: 'transport', startTime: '10:06', name: '成都東 -> 黃龍九寨站', note: '高鐵 C5792 (10:06 - 12:34)\n欣賞川西風光', transportType: 'public', travelTime: '2h28m' },
                    { id: 403, category: 'transport', startTime: '12:45', name: '接駁車 -> 溝口', note: 'Wechat 搜尋 "九旅悅行" 7日前訂票。\n班次: 12:30-12:50 或 13:40-14:00', hours: null, price: '需預訂', transportType: 'bus', travelTime: '2h' },
                    { id: 404, category: 'accommodation', startTime: '15:00', name: '入住: 漳札鎮溝口酒店', note: '適應海拔，晚餐吃犛牛肉火鍋', transportType: 'walk' }
                ],
                // Day 5: 12/28 (日)
                [
                    { id: 501, category: 'sightseeing', startTime: '07:00', name: '九寨溝: 進溝', note: '建議第一批入場 (Wechat "阿坝旅游" 預約)', hours: '07:00', price: '門票+車票', transportType: 'bus' },
                    { id: 502, category: 'sightseeing', startTime: '07:30', name: '則查窪溝線 (左)', note: '長海 & 五彩池 (步行800M)', hours: '07:30-11:30', transportType: 'bus' },
                    { id: 503, category: 'food', startTime: '12:00', name: '午餐: 諾日朗中心', note: '轉線點', hours: '12:00-13:00', transportType: 'bus' },
                    { id: 504, category: 'sightseeing', startTime: '13:00', name: '日則溝線 (右)', note: '五花海 — 珍珠灘 — 鏡海 (精華)', hours: '13:00-15:30', transportType: 'bus' },
                    { id: 505, category: 'sightseeing', startTime: '16:00', name: '諾日朗瀑布', note: '步行900米 (可略過)', hours: '16:00-16:30', transportType: 'walk' },
                    { id: 506, category: 'sightseeing', startTime: '16:30', name: '樹正群海 (主幹)', note: '主幹溝/樓盤溝線', hours: '16:30-17:30', transportType: 'bus' },
                    { id: 507, category: 'accommodation', startTime: '18:30', name: '返回酒店', note: '休息', transportType: 'walk' }
                ],
                // Day 6: 12/29 (一)
                [
                    { id: 601, category: 'transport', startTime: '08:00', name: '前往黃龍九寨站', note: '預留3.5小時 (車程約2小時)', transportType: 'car', travelTime: '2h' },
                    { id: 602, category: 'transport', startTime: '12:10', name: '黃龍九寨 -> 成都站', note: '高鐵 C5764 (12:10 - 14:17)', transportType: 'public', travelTime: '1h53m' },
                    { id: 603, category: 'transport', startTime: '15:18', name: '成都站 -> 重慶北', note: '高鐵 G3427 (15:18 - 16:54)', transportType: 'public', travelTime: '1h36m' },
                    { id: 604, category: 'accommodation', startTime: '17:30', name: '入住: 重慶市區酒店', note: '建議解放碑/洪崖洞附近，連住3晚', transportType: 'car', travelTime: '1h' },
                    { id: 605, category: 'sightseeing', startTime: '18:30', name: '洪崖洞夜景', note: '夜遊。\n備註：唔好食辣', hours: '18:30-21:00', transportType: 'walk' }
                ],
                // Day 7: 12/30 (二)
                [
                    { id: 701, category: 'sightseeing', startTime: '09:00', name: '重慶十八梯', note: '山城步道體驗', transportType: 'walk' },
                    { id: 702, category: 'sightseeing', startTime: '10:30', name: '磁器口古鎮', note: '滴滴約30分鐘', transportType: 'car' },
                    { id: 703, category: 'food', startTime: '13:00', name: '午餐 (古鎮)', note: '', hours: '13:00-14:00', transportType: 'walk' },
                    { id: 704, category: 'sightseeing', startTime: '15:00', name: '白公館/渣滓洞', note: '紅色旅遊點', transportType: 'car' },
                    { id: 705, category: 'sightseeing', startTime: '17:00', name: '南山一棵樹', note: '日落至夜景\n(後備: 抗戰遺址博物館)', transportType: 'car' },
                    { id: 706, category: 'food', startTime: '18:30', name: '晚餐: 泉水雞', note: '南山或南濱路', transportType: 'car' }
                ],
                // Day 8: 12/31 (三)
                [
                    { id: 801, category: 'sightseeing', startTime: '09:00', name: '鵝嶺二廠文創園', note: '文青打卡', transportType: 'car' },
                    { id: 802, category: 'sightseeing', startTime: '10:30', name: '李子壩輕軌穿樓', note: '步行下坡觀景台', transportType: 'walk' },
                    { id: 803, category: 'food', startTime: '12:00', name: '午餐', note: '長江索道南站（上新街）', transportType: 'car' },
                    { id: 804, category: 'sightseeing', startTime: '13:00', name: '長江索道', note: '南站（上新街）→ 北站（新華路）', hours: '13:00-14:00', price: '需查票價', transportType: 'other' },
                    { id: 805, category: 'sightseeing', startTime: '14:30', name: '白象居', note: '老居民樓', transportType: 'walk' },
                    { id: 806, category: 'sightseeing', startTime: '16:00', name: '湖廣會館', note: '', transportType: 'walk' },
                    { id: 807, category: 'shopping', startTime: '17:00', name: '解放碑/好吃街', note: '跨年倒數，可能封路。八一路好吃街覓食。', transportType: 'walk' }
                ],
                // Day 9: 1/1 (四)
                [
                    { id: 901, category: 'other', startTime: '早上', name: '自然醒', note: '訓到自然醒', transportType: 'stay' },
                    { id: 902, category: 'shopping', startTime: '12:00', name: '午膳 & 買手信', note: '解放碑步行街。\n備註: 1/1 商店可能放假，最好前兩日買定', transportType: 'walk' },
                    { id: 903, category: 'transport', startTime: '14:30', name: '前往江北機場', note: '車程30分鐘', transportType: 'car' },
                    { id: 904, category: 'flight', startTime: '17:30', name: '重慶 -> 深圳', note: '中國國航 CA4340 (17:30 - 19:35)', transportType: 'flight', travelTime: '2h05m' },
                    { id: 905, category: 'transport', startTime: '21:30', name: '深圳機場 -> 香港', note: '環島巴士 -> 油塘', transportType: 'bus' }
                ]
            ];

            const dates = ref([
                { date: '12/24', weekday: '三', hasTrain: false }, { date: '12/25', weekday: '四', hasTrain: true },
                { date: '12/26', weekday: '五', hasTrain: true }, { date: '12/27', weekday: '六', hasTrain: true },
                { date: '12/28', weekday: '日', hasTrain: false }, { date: '12/29', weekday: '一', hasTrain: true },
                { date: '12/30', weekday: '二', hasTrain: false }, { date: '12/31', weekday: '三', hasTrain: false },
                { date: '1/1', weekday: '四', hasTrain: false }
            ]);

            const weatherData = ref([
                { condition: 'cloudy', temp: '10~5' }, { condition: 'rain', temp: '9~4' }, { condition: 'snow', temp: '2~-5' },
                { condition: 'snow', temp: '-2~-10' }, { condition: 'snow', temp: '-1~-12' }, { condition: 'cloudy', temp: '8~3' },
                { condition: 'cloudy', temp: '11~7' }, { condition: 'cloudy', temp: '10~6' }, { condition: 'sunny', temp: '12~6' }
            ]);

            const hotels = ref([
                { name: '成都: 龍之夢瑞峯公寓', date: '12/24-27' }, { name: '九寨溝: 溝口酒店', date: '12/27-29' }, { name: '重慶: 解放碑酒店', date: '12/29-1/1' }
            ]);

            const itineraryData = ref([]);
            const shoppingList = ref([]);
            const expenses = ref([]);
            
            const isInitialLoading = ref(true);
            const isLoading = ref(false); // UI loading
            const loadingMessage = ref('');
            const syncStatus = ref('saved'); 
            const syncStatusText = ref('就緒');
            const dbConnected = ref(false);
            const errorMsg = ref('');

            const currentTab = ref('itinerary');
            const selectedDateIndex = ref(0);
            const showItineraryModal = ref(false);
            const showSimpleModal = ref(false);
            const showExpenseModal = ref(false);
            const showShoppingModal = ref(false);
            const isEditMode = ref(false);
            const editForm = ref({});
            const simpleForm = ref({});
            
            // ★★★ 修正花費 Modal 的變數 ★★★
            const newExpense = ref({
                name: '', amount: null, category: 'food', date: new Date().toISOString().substring(0, 10), payment: 'cash'
            });
            const newShoppingItem = ref({
                name: '', image: null
            });
            
            // 修正 newItinerary 未定義問題，其實應該用 newItinerary 統一
            const newItinerary = ref({
                id: null, name: '', category: 'sightseeing', startTime: '', hours: '', address: '', price: '', note: '', transportType: 'car', travelTime: '', isNoteExpanded: false
            });

            const currencyInput = ref(100);
            const currencyResult = ref(108);

            const currentItinerary = computed(() => itineraryData.value[selectedDateIndex.value] || []);
            const totalExpensesCNY = computed(() => expenses.value.reduce((acc, cur) => acc + (cur.amount || 0), 0));

            // --- Firebase ---
            const loadFromFirebase = () => {
                if (!db) {
                    itineraryData.value = initialItinerary;
                    isInitialLoading.value = false;
                    errorMsg.value = '資料庫未連線';
                    return;
                }
                
                docRef.get().then((doc) => {
                    dbConnected.value = true;
                    if (doc.exists) {
                        const data = doc.data();
                        
                        // 讀取時解包：從 Object Array 轉回 Array Array
                        if (data.itinerary) {
                            itineraryData.value = data.itinerary.map(dayWrapper => dayWrapper.items || []);
                        } else {
                            itineraryData.value = initialItinerary;
                        }
                        
                        shoppingList.value = data.shopping || [];
                        expenses.value = data.expenses || [];
                    } else {
                        itineraryData.value = initialItinerary;
                        saveToFirebase(); // 初始化
                    }
                }).catch((error) => {
                    console.error("Read failed:", error);
                    errorMsg.value = "讀取失敗: " + error.message;
                    syncStatus.value = 'error';
                    itineraryData.value = initialItinerary;
                }).finally(() => {
                    isInitialLoading.value = false;
                });
            };

            let saveTimeout = null;
            const saveToFirebase = () => {
                if (!db) return;
                syncStatus.value = 'saving';
                syncStatusText.value = '儲存中...';
                
                // 儲存時打包：將 Array Array 轉為 Object Array (Firebase 不支援 nested arrays)
                const safeItinerary = itineraryData.value.map(dayItems => ({ items: JSON.parse(JSON.stringify(dayItems)) }));

                docRef.set({
                    itinerary: safeItinerary,
                    shopping: JSON.parse(JSON.stringify(shoppingList.value)),
                    expenses: JSON.parse(JSON.stringify(expenses.value))
                }).then(() => {
                    syncStatus.value = 'saved';
                    syncStatusText.value = '已同步';
                    errorMsg.value = '';
                }).catch((error) => {
                    console.error("Save failed:", error);
                    syncStatus.value = 'error';
                    syncStatusText.value = '儲存失敗';
                    errorMsg.value = error.message;
                });
            };

            watch([itineraryData, shoppingList, expenses], () => {
                if (isInitialLoading.value) return;
                clearTimeout(saveTimeout);
                syncStatus.value = 'saving';
                syncStatusText.value = '變更待上傳...';
                saveTimeout = setTimeout(saveToFirebase, 1000);
            }, { deep: true });

            const resetToDefault = () => {
                if(confirm('確定要強制覆蓋資料庫，回復到原始 9 天預設行程嗎？')) {
                    itineraryData.value = JSON.parse(JSON.stringify(initialItinerary));
                    shoppingList.value = [];
                    expenses.value = [];
                    saveToFirebase();
                }
            };

            // --- 一般邏輯 ---
            const calcRate = () => currencyResult.value = Math.round(currencyInput.value * 1.08);
            
            // ★★★ ICON & COLOR MAPPING (依據需求修正) ★★★
            const getCategoryColor = (c) => ({ 
                sightseeing: 'bg-icon-green', // 綠色
                food: 'bg-icon-red',        // 紅色
                shopping: 'bg-indigo-500', 
                accommodation: 'bg-icon-purple', // 紫色
                flight: 'bg-icon-blue', // 藍色
                transport: 'bg-icon-orange', // 橙色
                other: 'bg-icon-grey', // 灰色
                walk: 'bg-icon-grey'
            }[c] || 'bg-icon-grey');

            const getCategoryIcon = (c) => ({ 
                sightseeing: 'fa-solid fa-camera', 
                food: 'fa-solid fa-bowl-rice', 
                shopping: 'fa-solid fa-bag-shopping', 
                accommodation: 'fa-solid fa-bed', 
                flight: 'fa-solid fa-plane-departure', 
                transport: 'fa-solid fa-train-subway', 
                other: 'fa-solid fa-info',
                walk: 'fa-solid fa-person-walking' // 步行小人圖示
            }[c] || 'fa-solid fa-info');

            const getWeatherIcon = (c) => ({ 
                snow: 'fa-solid fa-snowflake', 
                sunny: 'fa-solid fa-sun', 
                cloudy: 'fa-solid fa-cloud', 
                rain: 'fa-solid fa-cloud-showers-heavy' 
            }[c] || 'fa-solid fa-cloud');

            const getWeatherDescription = (c) => ({ 
                snow: '下雪/寒冷', 
                sunny: '晴朗', 
                cloudy: '多雲/陰天', 
                rain: '有雨/濕冷' 
            }[c] || '未知');

            const getTransportIcon = (t) => ({ 
                walk: 'fa-solid fa-person-walking', 
                car: 'fa-solid fa-car', 
                bus: 'fa-solid fa-bus', 
                public: 'fa-solid fa-train', 
                flight: 'fa-solid fa-plane', 
                boat: 'fa-solid fa-ship' 
            }[t] || 'fa-solid fa-arrow-right');

            const formatNoteDisplay = (note) => {
                if (!note) return '';
                if (note.includes('<')) return note;
                return note.replace(/\n/g, '<br>');
            };

            const openMap = (q) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`, '_blank');
            const openMapDirections = (s, e) => {
                const start = s.address || s.name;
                const end = e.address || e.name;
                window.open(`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(start)}&destination=${encodeURIComponent(end)}`, '_blank');
            };

            const execCmd = (cmd, val = null) => {
                document.execCommand(cmd, false, val);
                const editor = document.getElementById('noteEditor');
                if(editor) newItinerary.value.note = editor.innerHTML;
            };
            
            const updateNoteContent = (event) => {
                newItinerary.value.note = event.target.innerHTML;
            };

            // ★★★ 修正 openAddModal 邏輯 ★★★
            const openAddModal = () => {
                if(currentTab.value === 'itinerary') {
                    isEditMode.value = false;
                    newItinerary.value = { id: Date.now(), category: 'sightseeing', transportType: 'car', note: '', startTime: '', isNoteExpanded: false };
                    showItineraryModal.value = true;
                    // 清空編輯器 (加延遲避免DOM未準備好)
                    setTimeout(() => {
                        const editor = document.getElementById('noteEditor');
                        if (editor) editor.innerHTML = '';
                    }, 100);
                } else if (currentTab.value === 'shopping') {
                    newShoppingItem.value = { name: '', image: null };
                    showShoppingModal.value = true;
                } else if (currentTab.value === 'expenses') {
                    // 重置花費表單
                    newExpense.value = { name: '', amount: null, category: 'food', date: new Date().toISOString().substring(0, 10), payment: 'cash' };
                    showExpenseModal.value = true;
                }
            };

            const editItem = (item) => {
                isEditMode.value = true;
                newItinerary.value = JSON.parse(JSON.stringify(item));
                showItineraryModal.value = true;
                // 填充編輯器內容 (加延遲)
                setTimeout(() => {
                    const editor = document.getElementById('noteEditor');
                    if (editor) {
                        let displayContent = newItinerary.value.note || '';
                        // 如果是舊純文字資料，將 \n 轉為 <br> 再放入編輯器
                        if (!displayContent.match(/<[a-z][\s\S]*>/i)) {
                            displayContent = displayContent.replace(/\n/g, '<br>');
                        }
                        editor.innerHTML = displayContent;
                    }
                }, 100);
            };

            const saveItineraryItem = () => {
                if (!newItinerary.value.name) {
                    alert('行程名稱不能為空');
                    return;
                }
                
                // 確保從編輯器獲取最新內容
                const editor = document.getElementById('noteEditor');
                if (editor) {
                    newItinerary.value.note = editor.innerHTML;
                }

                const list = itineraryData.value[selectedDateIndex.value];
                if (!list) {
                    itineraryData.value[selectedDateIndex.value] = [];
                }
                
                // 獲取最新的引用
                const targetList = itineraryData.value[selectedDateIndex.value];
                
                if(isEditMode.value) {
                    const idx = targetList.findIndex(i => i.id === newItinerary.value.id);
                    if(idx !== -1) {
                        targetList[idx] = { ...newItinerary.value };
                    }
                } else {
                    targetList.push({ ...newItinerary.value });
                }
                
                // 強制觸發更新
                itineraryData.value[selectedDateIndex.value] = [...targetList];
                
                showItineraryModal.value = false;
            };

            const deleteItem = () => {
                if(!confirm('確定刪除？')) return;
                const idx = itineraryData.value[selectedDateIndex.value].findIndex(i => i.id === newItinerary.value.id);
                if(idx !== -1) itineraryData.value[selectedDateIndex.value].splice(idx, 1);
                showItineraryModal.value = false;
            };

            const moveItem = (idx, direction) => {
                const list = itineraryData.value[selectedDateIndex.value];
                const item = list.splice(idx, 1)[0];
                list.splice(idx + direction, 0, item);
            };

            // ★★★ 新增 Add Shopping Item ★★★
            const addShoppingItem = () => {
                 if (newShoppingItem.value.name.trim() === '') {
                    alert('商品名稱不能為空！');
                    return;
                }
                shoppingList.value.push({ ...newShoppingItem.value });
                showShoppingModal.value = false;
            };

            // ★★★ 新增 Add Expense ★★★
            const addExpense = () => {
                if (newExpense.value.name.trim() === '' || newExpense.value.amount === null || newExpense.value.amount <= 0) {
                    alert('請輸入有效名稱和金額！');
                    return;
                }
                expenses.value.push({ ...newExpense.value });
                // 排序
                expenses.value.sort((a, b) => new Date(b.date) - new Date(a.date));
                showExpenseModal.value = false;
            };

             const handleImageUpload = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        newShoppingItem.value.image = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };

            const deleteShoppingItem = (idx) => shoppingList.value.splice(idx, 1);
            const deleteExpenseItem = (idx) => expenses.value.splice(idx, 1);
            
            // 修正行程列表操作函數的參數
            const removeItineraryItem = (id) => {
                 if(!confirm('確定刪除？')) return;
                 const idx = itineraryData.value[selectedDateIndex.value].findIndex(i => i.id === id);
                 if(idx !== -1) itineraryData.value[selectedDateIndex.value].splice(idx, 1);
                 showItineraryModal.value = false;
            };
            
            const moveItineraryUp = (id) => {
                const list = itineraryData.value[selectedDateIndex.value];
                const index = list.findIndex(i => i.id === id);
                if (index > 0) {
                    const item = list.splice(index, 1)[0];
                    list.splice(index - 1, 0, item);
                }
            };
            
            const moveItineraryDown = (id) => {
                const list = itineraryData.value[selectedDateIndex.value];
                const index = list.findIndex(i => i.id === id);
                if (index < list.length - 1) {
                    const item = list.splice(index, 1)[0];
                    list.splice(index + 1, 0, item);
                }
            };

            onMounted(() => {
                loadFromFirebase();
            });

            return {
                currentTab, dates, selectedDateIndex, currentItinerary, hotels, weatherData,
                shoppingList, expenses, totalExpensesCNY, currencyInput, currencyResult, calcRate,
                getCategoryColor, getCategoryIcon, getWeatherIcon, getWeatherDescription, getTransportIcon,
                showItineraryModal, showSimpleModal, showExpenseModal, showShoppingModal, isEditMode, editForm, simpleForm,
                newExpense, newShoppingItem, newItinerary, // 暴露給 template
                openAddModal, editItem, saveItineraryItem, deleteItem, moveItem, saveSimpleItem, deleteShoppingItem, deleteExpenseItem,
                addShoppingItem, addExpense, handleImageUpload, removeItineraryItem, moveItineraryUp, moveItineraryDown,
                openMap, openMapDirections, execCmd, formatNoteDisplay, updateNoteContent,
                isInitialLoading, isLoading, loadingMessage, syncStatus, syncStatusText, dbConnected, errorMsg, resetToDefault, formatNumber
            };
        }
    }).mount('#app');
</script>
</body>
</html>
