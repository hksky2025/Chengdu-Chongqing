<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chengdu & Chongqing Trip 2024</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'snow-white': '#F9FAFB', 'ice-blue': '#E0F2FE', 'light-snow-blue': '#F0F9FF',
                        'deep-sea-blue': '#0369A1', 'accent-yellow': '#FBBF24', 'spicy-red': '#DC2626', 'soft-gray': '#F3F4F6'
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { background-color: #F0F9FF; font-family: 'Noto Sans TC', sans-serif; color: #334155; -webkit-tap-highlight-color: transparent; }
        .app-container { max-width: 480px; margin: 0 auto; min-height: 100vh; background-color: #ffffff; position: relative; padding-bottom: 90px; box-shadow: 0 0 30px rgba(0,0,0,0.05); }
        .header-image-container { width: 100%; height: 250px; background-color: #0c4a6e; border-radius: 0 0 35px 35px; overflow: hidden; position: relative; }
        .header-image-container img { width: 100%; height: 100%; object-fit: cover; opacity: 0.9; }
        .snow-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><circle cx="50" cy="50" r="1" fill="white" opacity="0.5"/></svg>'); z-index: 5; pointer-events: none; }
        
        .side-tab-bar { position: absolute; bottom: 45px; right: 16px; z-index: 30; display: flex; gap: 8px; }
        .tab-button { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.15); transition: 0.2s; background: white; color: #7DD3FC; }
        .tab-button.active { background: #0369A1; color: white; transform: scale(1.05); box-shadow: 0 6px 15px rgba(3,105,161,0.4); }
        
        .app-main { padding-top: 25px !important; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .card-shadow { box-shadow: 0 4px 20px rgba(186, 230, 253, 0.3); }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .note-content { max-height: 2.5rem; overflow: hidden; transition: 0.3s; line-height: 1.6; font-size: 0.9rem; }
        .note-content.expanded { max-height: 1000px; }
        .note-content b { font-weight: 800; } 
        
        .rich-editor-toolbar { padding: 8px; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; flex-direction: column; gap: 5px; }
        .rich-editor-content { min-height: 150px; max-height: 300px; overflow-y: auto; padding: 12px; outline: none; }
        .tool-btn { padding: 4px 8px; border-radius: 4px; background: white; border: 1px solid #e2e8f0; margin-right: 3px; font-size: 12px; cursor: pointer; }
        .color-dot { width: 20px; height: 20px; border-radius: 50%; display: inline-block; cursor: pointer; border: 1px solid #ddd; }
        
        .expenses-banner { background: linear-gradient(135deg, #BE123C 0%, #FB7185 100%); color: white; padding: 2rem; border-radius: 1.5rem; position: relative; overflow: hidden; margin-bottom: 1.5rem; }
    </style>
</head>
<body>

<div id="app" class="app-container">
    <div class="header-bg relative">
        <div class="header-image-container">
            <img src="https://images.unsplash.com/photo-1542036647-794d0752d580?q=80&w=1000&auto=format&fit=crop">
        </div>
        <div class="snow-layer"></div> 
        <div class="side-tab-bar">
            <button @click="currentTab='itinerary'" :class="{'active': currentTab==='itinerary'}" class="tab-button"><i class="fa-solid fa-map-location-dot"></i></button>
            <button @click="currentTab='info'" :class="{'active': currentTab==='info'}" class="tab-button"><i class="fa-solid fa-circle-info"></i></button>
            <button @click="currentTab='shopping'" :class="{'active': currentTab==='shopping'}" class="tab-button"><i class="fa-solid fa-basket-shopping"></i></button>
            <button @click="currentTab='expenses'" :class="{'active': currentTab==='expenses'}" class="tab-button"><i class="fa-solid fa-coins"></i></button>
        </div>
    </div>

    <main class="p-4 app-main">
        <div v-if="currentTab === 'itinerary'" class="animate-fade-in">
            <div class="flex overflow-x-auto hide-scrollbar space-x-3 pb-4 mb-2 px-1 sticky top-0 bg-white z-20 pt-2 -mx-4 px-4 border-b border-gray-100">
                <div v-for="(day, index) in dates" :key="index" @click="selectedDateIndex = index"
                     class="flex-shrink-0 w-[58px] h-[68px] rounded-xl flex flex-col items-center justify-center cursor-pointer transition-all border-2 shadow-sm"
                     :class="selectedDateIndex === index ? 'bg-deep-sea-blue text-white border-deep-sea-blue scale-105' : 'bg-white text-gray-400 border-white'">
                    <span class="text-sm font-bold">{{ day.weekday }}</span> 
                    <span class="text-xs opacity-70">{{ day.date }}</span> 
                </div>
            </div>

            <div v-if="weatherData[selectedDateIndex]" class="mb-4 bg-snow-white border border-ice-blue rounded-2xl p-4 flex justify-between items-center shadow-md">
                <div class="flex items-start text-deep-sea-blue space-x-4">
                    <i :class="getWeatherIcon(weatherData[selectedDateIndex].condition)" class="text-4xl text-blue-500"></i>
                    <div class="pt-1">
                        <span class="text-2xl font-extrabold">{{ weatherData[selectedDateIndex].temp }}°C</span>
                    </div>
                </div>
                <div class="text-right text-xs text-gray-600">
                    <span class="font-bold block">{{ getWeatherDescription(weatherData[selectedDateIndex].condition) }}</span>
                    <span v-if="dates[selectedDateIndex].hasTrain" class="mt-1 block text-deep-sea-blue font-bold"><i class="fa-solid fa-train text-accent-yellow"></i> 高鐵日</span>
                </div>
            </div>

            <div class="space-y-4 pb-20">
                <div v-for="(item, idx) in currentItinerary" :key="item.id" class="relative">
                    <div v-if="idx > 0" class="pl-8 pb-2 flex items-center text-xs text-gray-400">
                        <div class="h-6 w-0.5 bg-gray-200 absolute left-6 -top-3"></div>
                        <i :class="getTransportIcon(currentItinerary[idx].transportType)" class="mr-2" @click="openMapDirections(currentItinerary[idx-1], item)"></i>
                        <span class="font-bold">{{ item.travelTime || '移動' }}</span>
                    </div>
                    
                    <div class="bg-white rounded-3xl p-5 card-shadow flex items-start border border-ice-blue/50 relative">
                        <div class="mr-4 flex flex-col items-center min-w-[50px]">
                            <div class="p-2 rounded-full text-white shadow-md mb-1" :class="getCategoryColor(item.category)"><i :class="getCategoryIcon(item.category)"></i></div>
                            <span class="text-xs font-bold text-gray-600">{{ item.startTime }}</span>
                        </div>
                        <div class="flex-1 pb-1 pr-6">
                            <h3 class="text-lg font-bold text-gray-800 leading-tight">{{ item.name }}</h3>
                            <div class="text-sm text-gray-500 mt-2 space-y-1">
                                <p v-if="item.price"><i class="fa-solid fa-ticket w-4 text-center mr-1 text-ice-blue"></i> {{ item.price }}</p>
                                <p v-if="item.address" @click="openMap(item.address)" class="cursor-pointer hover:text-blue-500"><i class="fa-solid fa-location-dot w-4 text-center mr-1 text-ice-blue"></i> {{ item.address }}</p>
                            </div>
                            <div v-if="item.note" class="mt-3 text-xs bg-gray-50 p-2.5 rounded-lg border border-gray-100">
                                <div class="note-content" :class="{'expanded': item.isNoteExpanded}" v-html="formatNoteDisplay(item.note)"></div>
                                <button v-if="item.note.length > 50" @click="item.isNoteExpanded = !item.isNoteExpanded" class="text-blue-600 font-bold mt-1 block">{{ item.isNoteExpanded ? '收合' : '展開' }}</button>
                            </div>
                        </div>
                        <div class="absolute top-3 right-3 flex flex-col space-y-1">
                            <button @click.stop="moveItem(idx, -1)" v-if="idx>0" class="w-7 h-7 bg-gray-100 rounded-full text-xs text-gray-500"><i class="fa-solid fa-arrow-up"></i></button>
                            <button @click.stop="moveItem(idx, 1)" v-if="idx<currentItinerary.length-1" class="w-7 h-7 bg-gray-100 rounded-full text-xs text-gray-500"><i class="fa-solid fa-arrow-down"></i></button>
                            <button @click.stop="editItem(item)" class="w-7 h-7 bg-blue-50 text-blue-600 rounded-full text-xs"><i class="fa-solid fa-pencil"></i></button>
                        </div>
                    </div>
                </div>
                <div v-if="currentItinerary.length === 0" class="text-center py-10 text-gray-300">
                    <p>本日無行程，點擊右下角新增</p>
                </div>
            </div>
        </div>

        <div v-if="currentTab === 'info'" class="space-y-5 animate-fade-in">
            <div class="bg-gradient-to-r from-red-600 to-pink-500 rounded-3xl p-6 text-white shadow-xl">
                <h3 class="font-bold text-lg mb-4"><i class="fa-solid fa-calculator mr-2"></i> 匯率換算</h3>
                <div class="flex justify-between items-center gap-2">
                    <input type="number" v-model="currencyInput" @input="calcRate" class="w-1/2 bg-white/20 rounded-xl px-3 py-2 text-white placeholder-white text-lg font-bold" placeholder="CNY">
                    <i class="fa-solid fa-arrow-right"></i>
                    <div class="w-1/2 bg-white/10 rounded-xl px-3 py-2 text-lg font-bold">HK$ {{ currencyResult }}</div>
                </div>
            </div>

            <div class="bg-indigo-50 border border-indigo-100 rounded-3xl p-6 shadow-sm">
                <h3 class="font-bold text-indigo-800 mb-2"><i class="fa-solid fa-floppy-disk mr-2"></i> 永久儲存修改</h3>
                <p class="text-xs text-indigo-600 mb-4">因為瀏覽器安全限制，網頁無法直接覆蓋原檔。請在修改完成後，點擊下方按鈕下載包含最新內容的 HTML，並覆蓋您原本的檔案。</p>
                <button @click="downloadUpdatedHTML" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 active:scale-95 transition-transform">
                    <i class="fa-solid fa-download mr-2"></i> 下載最新版 HTML (覆蓋舊檔)
                </button>
            </div>

            <div class="bg-white rounded-3xl p-6 card-shadow">
                <h3 class="font-bold text-gray-800 mb-4 border-b pb-2">住宿資訊</h3>
                <ul class="space-y-4">
                    <li v-for="h in hotels" class="border-b last:border-0 pb-3">
                        <div class="font-bold text-gray-700">{{ h.name }}</div>
                        <div class="text-xs text-gray-400">{{ h.date }}</div>
                    </li>
                </ul>
            </div>
        </div>

        <div v-if="currentTab === 'shopping'" class="animate-fade-in grid grid-cols-2 gap-4">
            <div v-for="(item, idx) in shoppingList" class="bg-white rounded-2xl p-3 card-shadow relative">
                <div class="aspect-square bg-gray-50 rounded-xl mb-2 overflow-hidden relative">
                    <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                    <div v-else class="w-full h-full flex items-center justify-center text-gray-300"><i class="fa-solid fa-image text-2xl"></i></div>
                    <button @click="shoppingList.splice(idx,1)" class="absolute top-1 right-1 bg-black/50 text-white w-6 h-6 rounded-full text-xs"><i class="fa-solid fa-xmark"></i></button>
                </div>
                <div class="font-bold text-sm text-gray-800 px-1">{{ item.name }}</div>
            </div>
        </div>

        <div v-if="currentTab === 'expenses'" class="animate-fade-in">
            <div class="expenses-banner mb-6">
                <p class="text-sm opacity-80">總花費 (CNY)</p>
                <h2 class="text-4xl font-bold">¥ {{ totalExpensesCNY }}</h2>
                <p class="text-right text-xs mt-2">約 HK$ {{ Math.round(totalExpensesCNY * 1.08) }}</p>
            </div>
            <div class="bg-white rounded-t-3xl p-6 shadow-lg -mx-4 min-h-[300px]">
                <div v-for="(exp, idx) in expenses" class="flex justify-between items-center border-b py-3">
                    <div class="flex items-center">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-xs mr-3" :class="getCategoryColor(exp.category)"><i :class="getCategoryIcon(exp.category)"></i></div>
                        <div><div class="font-bold text-gray-700 text-sm">{{ exp.name }}</div><div class="text-[10px] text-gray-400">{{ exp.date }}</div></div>
                    </div>
                    <div class="flex items-center">
                        <span class="font-bold text-gray-700 mr-3">¥{{ exp.amount }}</span>
                        <button @click="expenses.splice(idx,1)" class="text-red-300"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <button v-if="currentTab!=='info'" @click="openAddModal" class="fixed bottom-6 right-6 w-14 h-14 bg-accent-yellow rounded-full shadow-lg text-white text-2xl flex items-center justify-center z-40 active:scale-90 transition-transform"><i class="fa-solid fa-plus"></i></button>

    <div v-if="showItineraryModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl w-full max-w-sm p-5 shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-lg mb-4 text-center">{{ isEditMode ? '編輯行程' : '新增行程' }}</h3>
            <div class="space-y-3">
                <select v-model="editForm.category" class="w-full bg-gray-50 p-3 rounded-xl text-sm">
                    <option value="sightseeing">景點</option><option value="food">飲食</option><option value="transport">交通</option><option value="shopping">購物</option><option value="accommodation">住宿</option><option value="flight">航班</option><option value="other">其他</option>
                </select>
                <input v-model="editForm.name" placeholder="名稱" class="w-full bg-gray-50 p-3 rounded-xl text-sm">
                <div class="grid grid-cols-2 gap-2">
                    <input v-model="editForm.startTime" placeholder="時間 (09:00)" class="bg-gray-50 p-3 rounded-xl text-sm">
                    <select v-model="editForm.transportType" class="bg-gray-50 p-3 rounded-xl text-sm">
                        <option value="walk">步行</option><option value="car">打車</option><option value="public">高鐵/地鐵</option><option value="bus">巴士</option><option value="other">其他</option>
                    </select>
                </div>
                <input v-model="editForm.address" placeholder="地址 (用於地圖)" class="w-full bg-gray-50 p-3 rounded-xl text-sm">
                <input v-model="editForm.price" placeholder="費用 (選填)" class="w-full bg-gray-50 p-3 rounded-xl text-sm">
                
                <div class="border rounded-xl overflow-hidden bg-gray-50">
                    <div class="rich-editor-toolbar">
                        <div class="flex flex-wrap">
                            <button @mousedown.prevent="execCmd('bold')" class="tool-btn"><i class="fa-solid fa-bold"></i></button>
                            <button @mousedown.prevent="execCmd('fontSize','1')" class="tool-btn text-[10px]">A</button>
                            <button @mousedown.prevent="execCmd('fontSize','3')" class="tool-btn text-xs">A</button>
                            <button @mousedown.prevent="execCmd('fontSize','5')" class="tool-btn text-lg">A</button>
                            <button @mousedown.prevent="execCmd('removeFormat')" class="tool-btn"><i class="fa-solid fa-eraser"></i></button>
                        </div>
                        <div class="flex gap-1 overflow-x-auto pb-1">
                            <span class="text-[10px] pt-1 text-gray-400">字:</span>
                            <span v-for="c in ['#000','#DC2626','#2563EB','#059669','#EA580C']" :key="c" @mousedown.prevent="execCmd('foreColor', c)" class="color-dot" :style="{background:c}"></span>
                        </div>
                        <div class="flex gap-1 overflow-x-auto">
                            <span class="text-[10px] pt-1 text-gray-400">底:</span>
                            <span v-for="c in ['#FEF08A','#BAE6FD','#BBF7D0','#FBCFE8','transparent']" :key="c" @mousedown.prevent="execCmd('hiliteColor', c)" class="color-dot" :style="{background:c}"></span>
                        </div>
                    </div>
                    <div id="editor" contenteditable="true" class="rich-editor-content text-sm bg-white" @input="editForm.note = $event.target.innerHTML"></div>
                </div>
            </div>
            
            <div class="flex gap-3 mt-5">
                <button @click="showItineraryModal=false" class="flex-1 py-3 bg-gray-100 text-gray-500 rounded-xl font-bold text-sm">取消</button>
                <button v-if="isEditMode" @click="deleteItem" class="w-1/3 py-3 bg-red-100 text-red-500 rounded-xl font-bold text-sm">刪除</button>
                <button @click="saveItem" class="flex-1 py-3 bg-deep-sea-blue text-white rounded-xl font-bold text-sm shadow-lg">儲存</button>
            </div>
        </div>
    </div>

    <div v-if="showSimpleModal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-6">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6">
            <h3 class="font-bold text-lg mb-4 text-center">新增項目</h3>
            <input v-model="simpleForm.name" placeholder="名稱" class="w-full bg-gray-50 p-3 rounded-xl mb-3">
            <input v-if="currentTab==='expenses'" v-model.number="simpleForm.amount" type="number" placeholder="金額" class="w-full bg-gray-50 p-3 rounded-xl mb-3">
            
            <div v-if="currentTab==='shopping'" class="mb-3">
                <input type="file" @change="e=>{const r=new FileReader();r.onload=ev=>simpleForm.image=ev.target.result;r.readAsDataURL(e.target.files[0])}" class="text-xs">
            </div>

            <div class="flex gap-3">
                <button @click="showSimpleModal=false" class="flex-1 py-3 bg-gray-100 text-gray-500 rounded-xl">取消</button>
                <button @click="saveSimpleItem" class="flex-1 py-3 bg-accent-yellow text-white rounded-xl font-bold">新增</button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, computed, onMounted, nextTick } = Vue;

    createApp({
        setup() {
            // --- 預設資料區 (請在此修改你的初始行程) ---
            const initialItinerary = [
                // 格式: [ Day 1 行程陣列 ], [ Day 2 行程陣列 ] ...
                [ // Day 1: 12/24
                    { id: 1, category: 'transport', startTime: '07:15', name: '香港出發 (油塘)', note: '環島中港通', transportType: 'bus' },
                    { id: 2, category: 'flight', startTime: '13:45', name: '飛往成都 (CA4340)', note: '預計16:30抵達', transportType: 'flight' },
                    { id: 3, category: 'accommodation', startTime: '17:00', name: '入住酒店', note: '龍之夢瑞峯公寓', transportType: 'car' },
                    { id: 4, category: 'sightseeing', startTime: '19:00', name: '望平街晚餐', note: '', transportType: 'walk' }
                ],
                [ // Day 2: 12/25
                    { id: 10, category: 'transport', startTime: '08:49', name: '前往樂山大佛', note: '高鐵 D1791', transportType: 'public' },
                    { id: 11, category: 'sightseeing', startTime: '10:15', name: '船遊樂山大佛', note: '烏尤壩碼頭登船', transportType: 'boat' },
                    { id: 12, category: 'food', startTime: '12:30', name: '午餐: 蹺腳牛肉', note: '', transportType: 'walk' }
                ],
                [ // Day 3: 12/26
                    { id: 20, category: 'transport', startTime: '08:04', name: '前往峨眉山', note: '高鐵 C6343', transportType: 'public' },
                    { id: 21, category: 'sightseeing', startTime: '12:00', name: '金頂', note: '普賢菩薩聖像', transportType: 'other' }
                ],
                [ // Day 4: 12/27
                    { id: 30, category: 'transport', startTime: '10:06', name: '前往九寨溝', note: '高鐵 C5792\n接駁車需預訂', transportType: 'public' },
                    { id: 31, category: 'accommodation', startTime: '15:00', name: '入住溝口酒店', note: '適應海拔', transportType: 'walk' }
                ],
                [ // Day 5: 12/28
                    { id: 40, category: 'sightseeing', startTime: '07:00', name: '九寨溝全日遊', note: 'Y字型路線: 長海 -> 五花海 -> 樹正群海', transportType: 'bus' }
                ],
                [ // Day 6: 12/29
                    { id: 50, category: 'transport', startTime: '15:18', name: '前往重慶', note: '成都轉車 G3427', transportType: 'public' },
                    { id: 51, category: 'sightseeing', startTime: '18:30', name: '洪崖洞夜景', note: '', transportType: 'walk' }
                ],
                [ // Day 7: 12/30
                    { id: 60, category: 'sightseeing', startTime: '10:30', name: '磁器口古鎮', note: '', transportType: 'car' },
                    { id: 61, category: 'sightseeing', startTime: '17:00', name: '南山一棵樹', note: '看夜景', transportType: 'car' }
                ],
                [ // Day 8: 12/31
                    { id: 70, category: 'sightseeing', startTime: '10:30', name: '李子壩輕軌', note: '穿樓體驗', transportType: 'public' },
                    { id: 71, category: 'sightseeing', startTime: '13:00', name: '長江索道', note: '', transportType: 'other' },
                    { id: 72, category: 'shopping', startTime: '17:00', name: '解放碑跨年', note: '', transportType: 'walk' }
                ],
                [ // Day 9: 1/1
                    { id: 80, category: 'flight', startTime: '17:30', name: '飛往深圳', note: 'CA4340', transportType: 'flight' },
                    { id: 81, category: 'transport', startTime: '21:30', name: '回香港', note: '環島巴士', transportType: 'bus' }
                ]
            ];

            const dates = ref([
                { date: '12/24', weekday: '三', hasTrain: false }, { date: '12/25', weekday: '四', hasTrain: true },
                { date: '12/26', weekday: '五', hasTrain: true }, { date: '12/27', weekday: '六', hasTrain: true },
                { date: '12/28', weekday: '日', hasTrain: false }, { date: '12/29', weekday: '一', hasTrain: true },
                { date: '12/30', weekday: '二', hasTrain: false }, { date: '12/31', weekday: '三', hasTrain: false },
                { date: '1/1', weekday: '四', hasTrain: false }
            ]);

            const weatherData = ref([
                { condition: 'cloudy', temp: '10~5' }, { condition: 'rain', temp: '9~4' }, { condition: 'snow', temp: '2~-5' },
                { condition: 'snow', temp: '-2~-10' }, { condition: 'snow', temp: '-1~-12' }, { condition: 'cloudy', temp: '8~3' },
                { condition: 'cloudy', temp: '11~7' }, { condition: 'cloudy', temp: '10~6' }, { condition: 'sunny', temp: '12~6' }
            ]);

            const hotels = ref([
                { name: '成都: 龍之夢瑞峯公寓', date: '12/24-27' }, { name: '九寨溝: 溝口酒店', date: '12/27-29' }, { name: '重慶: 解放碑酒店', date: '12/29-1/1' }
            ]);

            // 狀態變數
            const itineraryData = ref(initialItinerary);
            const shoppingList = ref([{ name: '火鍋底料', image: null }]);
            const expenses = ref([{ name: '機票', amount: 2000, category: 'flight', date: '2024-11-15' }]);
            
            const currentTab = ref('itinerary');
            const selectedDateIndex = ref(0);
            
            // Modal 控制
            const showItineraryModal = ref(false);
            const showSimpleModal = ref(false);
            const isEditMode = ref(false);
            const editForm = ref({});
            const simpleForm = ref({});
            
            // 匯率
            const currencyInput = ref(100);
            const currencyResult = ref(Math.round(100 * 1.08));

            // Computed
            const currentItinerary = computed(() => itineraryData.value[selectedDateIndex.value] || []);
            const totalExpensesCNY = computed(() => expenses.value.reduce((acc, cur) => acc + (cur.amount || 0), 0));

            // Methods
            const calcRate = () => currencyResult.value = Math.round(currencyInput.value * 1.08);
            
            const getCategoryColor = (c) => ({ sightseeing: 'bg-green-600', food: 'bg-red-600', shopping: 'bg-indigo-500', accommodation: 'bg-purple-600', flight: 'bg-blue-600', transport: 'bg-orange-500', other: 'bg-gray-500' }[c] || 'bg-gray-500');
            const getCategoryIcon = (c) => ({ sightseeing: 'fa-camera', food: 'fa-bowl-food', shopping: 'fa-bag-shopping', accommodation: 'fa-bed', flight: 'fa-plane', transport: 'fa-train', other: 'fa-info' }[c] || 'fa-info');
            const getWeatherIcon = (c) => ({ snow: 'fa-snowflake', sunny: 'fa-sun', cloudy: 'fa-cloud', rain: 'fa-cloud-showers-heavy' }[c] || 'fa-cloud');
            const getWeatherDescription = (c) => ({ snow: '下雪/寒冷', sunny: '晴朗', cloudy: '多雲', rain: '有雨' }[c] || '未知');
            const getTransportIcon = (t) => ({ walk: 'fa-person-walking', car: 'fa-car', bus: 'fa-bus', public: 'fa-train', flight: 'fa-plane', boat: 'fa-ship' }[t] || 'fa-arrow-right');

            const formatNoteDisplay = (note) => {
                if (!note) return '';
                if (note.includes('<')) return note; // 已經是 HTML
                return note.replace(/\n/g, '<br>');
            };

            const openMap = (q) => window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`, '_blank');
            const openMapDirections = (s, e) => {
                const start = s.address || s.name;
                const end = e.address || e.name;
                window.open(`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(start)}&destination=${encodeURIComponent(end)}`, '_blank');
            };

            // --- 編輯器邏輯 ---
            const execCmd = (cmd, val = null) => {
                document.execCommand(cmd, false, val);
                const editor = document.getElementById('editor');
                if(editor) editForm.value.note = editor.innerHTML;
            };

            // --- 行程 CRUD ---
            const openAddModal = () => {
                if(currentTab.value === 'itinerary') {
                    isEditMode.value = false;
                    editForm.value = { id: Date.now(), category: 'sightseeing', transportType: 'car', note: '', startTime: '' };
                    showItineraryModal.value = true;
                    nextTick(() => document.getElementById('editor').innerHTML = '');
                } else {
                    simpleForm.value = {};
                    showSimpleModal.value = true;
                }
            };

            const editItem = (item) => {
                isEditMode.value = true;
                editForm.value = JSON.parse(JSON.stringify(item));
                showItineraryModal.value = true;
                nextTick(() => {
                    const editor = document.getElementById('editor');
                    if(editor) editor.innerHTML = formatNoteDisplay(editForm.value.note || '');
                });
            };

            const saveItem = () => {
                // 同步編輯器內容
                const editor = document.getElementById('editor');
                if(editor) editForm.value.note = editor.innerHTML;

                if(!editForm.value.name) return alert('請輸入名稱');

                const list = itineraryData.value[selectedDateIndex.value];
                
                if(isEditMode.value) {
                    // ★ 關鍵：找到索引並直接覆蓋物件，確保 Vue 響應更新
                    const idx = list.findIndex(i => i.id === editForm.value.id);
                    if(idx !== -1) {
                        list[idx] = { ...editForm.value }; 
                    }
                } else {
                    list.push({ ...editForm.value });
                }
                
                // 強制觸發更新
                itineraryData.value[selectedDateIndex.value] = [...list];
                showItineraryModal.value = false;
            };

            const deleteItem = () => {
                if(!confirm('確定刪除？')) return;
                const list = itineraryData.value[selectedDateIndex.value];
                const idx = list.findIndex(i => i.id === editForm.value.id);
                if(idx !== -1) {
                    list.splice(idx, 1);
                    itineraryData.value[selectedDateIndex.value] = [...list]; // 強制更新
                }
                showItineraryModal.value = false;
            };

            const moveItem = (idx, direction) => {
                const list = itineraryData.value[selectedDateIndex.value];
                const item = list.splice(idx, 1)[0];
                list.splice(idx + direction, 0, item);
                itineraryData.value[selectedDateIndex.value] = [...list];
            };

            const saveSimpleItem = () => {
                if(currentTab.value === 'shopping') shoppingList.value.push({ ...simpleForm.value });
                if(currentTab.value === 'expenses') expenses.value.push({ ...simpleForm.value, date: new Date().toISOString().split('T')[0] });
                showSimpleModal.value = false;
            };

            // ★★★ 自動更新原始碼並下載功能 ★★★
            const downloadUpdatedHTML = () => {
                // 1. 取得當前網頁的 HTML
                let htmlContent = document.documentElement.outerHTML;

                // 2. 將當前的資料轉成 JSON 字串
                const newItineraryJson = JSON.stringify(itineraryData.value);
                const newShoppingJson = JSON.stringify(shoppingList.value);
                const newExpensesJson = JSON.stringify(expenses.value);

                // 3. 使用正則表達式替換原始碼中的資料部分
                // 注意：這裡假設原始碼格式是 const itineraryData = ref([...]);
                // 我們需要非常小心地匹配
                
                // 替換行程
                htmlContent = htmlContent.replace(
                    /const itineraryData = ref\(\[([\s\S]*?)\]\);/m,
                    `const itineraryData = ref(${newItineraryJson});`
                );
                
                // 替換購物清單
                htmlContent = htmlContent.replace(
                    /const shoppingList = ref\(\[([\s\S]*?)\]\);/m,
                    `const shoppingList = ref(${newShoppingJson});`
                );

                // 替換花費
                htmlContent = htmlContent.replace(
                    /const expenses = ref\(\[([\s\S]*?)\]\);/m,
                    `const expenses = ref(${newExpensesJson});`
                );

                // 4. 建立下載連結
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = '成都重慶_最新行程.html'; // 設定下載檔名
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('已下載最新版 HTML！\n請用此新檔案覆蓋您原本的檔案，即可永久保存修改。');
            };

            return {
                currentTab, dates, selectedDateIndex, currentItinerary, hotels, weatherData,
                shoppingList, expenses, totalExpensesCNY, currencyInput, currencyResult, calcRate,
                getCategoryColor, getCategoryIcon, getWeatherIcon, getWeatherDescription, getTransportIcon,
                showItineraryModal, showSimpleModal, isEditMode, editForm, simpleForm,
                openAddModal, editItem, saveItem, deleteItem, moveItem, saveSimpleItem,
                openMap, openMapDirections, execCmd, formatNoteDisplay,
                downloadUpdatedHTML
            };
        }
    }).mount('#app');
</script>
</body>
</html>
